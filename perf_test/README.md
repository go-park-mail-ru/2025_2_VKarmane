## Нагрузочное тестирование API

Было проведено нагрузочное тестирование следующих эндпоинтов:

- `POST /api/v1/operations/account/17` — создание транзакций  
- `GET /api/v1/operations/account/17/operation/id` — получение транзакций

### Используемые инструменты

- [wrk](https://github.com/wg/wrk) — утилита для нагрузочного тестирования HTTP  
- Lua-скрипты для генерации запросов:
  - `create_transactions.lua` — создание транзакций  
  - `get_transactions.lua` — получение транзакций

### Результаты

Итоговые результаты тестирования представлены на скриншотах:

- Создание транзакций: `insert.png`  
- Получение транзакций: `select.png`  

Кроме того, значения RPS, полученные в ходе нагрузочного тестирования, были **сравнены с метриками в Grafana**, что позволило сопоставить результаты `wrk` с фактической нагрузкой на сервис. Скриншоты из Grafana:

- Создание транзакций: `insert_grafana.png`  
- Получение транзакций: `select_grafana.png`  

### Выводы

В текущей конфигурации сервис **не способен стабильно работать при высоких нагрузках**.

1. **Критически малый объём Heap-памяти Elasticsearch**

   Elasticsearch был запущен с параметрами:
-Xms512m -Xmx512m

Данный объём памяти является **недостаточным** для корректной работы Elasticsearch.  
Для справки: Elasticsearch рекомендует **минимум 4 ГБ оперативной памяти** для стабильной работы.  
Значение 512 МБ — это минимальный порог, при котором Elasticsearch запускается.

При нагрузочном тестировании (около 100 одновременных соединений и интенсивные POST-запросы на индексацию) heap-память заполняется практически мгновенно. В результате срабатывает **Circuit Breaker** — внутренний защитный механизм Elasticsearch, который начинает отклонять запросы для предотвращения `OutOfMemoryError`.  
Это напрямую приводит к появлению **HTTP 500** ответов и деградации производительности.

2. **Одноузловой режим работы Elasticsearch**

Elasticsearch запущен в режиме:
discovery.type=single-node

В данном режиме один узел одновременно выполняет все роли:
- координация запросов;
- индексация данных;
- выполнение поисковых запросов.

При высокой нагрузке на запись (POST `/api/v1/operations/account/17`) ресурсы CPU и диска активно используются процессами индексации. В результате GET-запросы вынуждены ожидать освобождения ресурсов, что приводит к **значительным задержкам ответа**.  
Данное поведение наблюдается в логах `wrk` в виде latency до **2 секунд и более**.

3. **Общее состояние системы под нагрузкой**

Основными bottleneck’ами системы являются:
- недостаточный объём heap-памяти Elasticsearch;
- одноузловая конфигурация без горизонтального масштабирования.

Для повышения производительности и устойчивости системы под нагрузкой **необходимо**:
- увеличить heap-память Elasticsearch (не менее 4 ГБ);
- перейти к многоузловой конфигурации Elasticsearch (увеличить количество кластеров/нод);
- после внесения изменений повторно провести нагрузочное тестирование.