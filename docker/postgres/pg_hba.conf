#
# pg_hba.conf for VKarmane
# Управление доступом к PostgreSQL
#

# --------------------------------------------------------
# Локальные подключения внутри контейнера
# Используем peer authentication с маппингом из pg_ident.conf
# --------------------------------------------------------

# Суперпользователь postgres
local   all             postgres                                peer map=local_admin

# Администратор vkarmane_admin (если создан системный пользователь vkarmane_admin_os)
local   vkarmane        vkarmane_admin                         peer map=local_admin

# --------------------------------------------------------
# Подключения с localhost (хостовая машина)
# Только для суперпользователей (postgres, vkarmane)
# --------------------------------------------------------

host    vkarmane        vkarmane        127.0.0.1/32            scram-sha-256
host    vkarmane        vkarmane        ::1/128                 scram-sha-256
host    vkarmane        postgres        127.0.0.1/32            scram-sha-256
host    vkarmane        postgres        ::1/128                 scram-sha-256

# --------------------------------------------------------
# Подключения из docker-сети приложения
# только для сервисного пользователя vkarmane_app
# (сервисы из docker-compose подключаются от его имени)
# --------------------------------------------------------

host    vkarmane        vkarmane_app    172.16.0.0/12           scram-sha-256

# --------------------------------------------------------
# Подключения для учетной записи администратора
# Только из указанной админской подсети
# --------------------------------------------------------

host    vkarmane        vkarmane_admin  10.0.0.0/24             scram-sha-256

# --------------------------------------------------------
# Всё остальное — запрещаем
# --------------------------------------------------------

host    all             all             0.0.0.0/0               reject
