# PostgreSQL Configuration для VKarmane
# Настройки логирования и мониторинга

# ========================================================
# Основные параметры
# ========================================================

max_connections = 100

listen_addresses = '*'

hba_file = '/etc/postgresql/pg_hba.conf'
ident_file = '/etc/postgresql/pg_ident.conf'

# ========================================================
# Логирование
# ========================================================

logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

log_rotation_age = 1d
log_rotation_size = 100MB

log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000

log_statement = 'all'
log_duration = on                
log_connections = on                
log_disconnections = on            
log_lock_waits = on                 

log_destination = 'stderr'          # Вывод в stderr (Docker перехватывает)

# ========================================================
# Расширения для мониторинга
# ========================================================

shared_preload_libraries = 'pg_stat_statements,auto_explain'

pg_stat_statements.max = 10000      
pg_stat_statements.track = all      
pg_stat_statements.track_utility = on

auto_explain.log_min_duration = 1000       
auto_explain.log_analyze = on               
auto_explain.log_verbose = on            
auto_explain.log_buffers = on           
auto_explain.log_nested_statements = on 
auto_explain.log_format = text              

# ========================================================
# Производительность - Память
# ========================================================

shared_buffers = 256MB
work_mem = 16MB
maintenance_work_mem = 512MB
effective_cache_size = 512MB

# ========================================================
# Производительность - Таймауты
# ========================================================

statement_timeout = 30000
lock_timeout = 10000              

# ========================================================
# Дополнительные настройки
# ========================================================

track_io_timing = on
track_functions = all

